global
    daemon
    log stdout len 32768 local0 info
    stats socket /var/run/haproxy.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy

defaults
    mode tcp
    timeout connect 5s
    timeout client 30s
    timeout server 30s
    option tcplog
    log global

# Frontend for Redis write operations (master only)
frontend redis_write_frontend
    bind *:6379
    default_backend redis_master

# Frontend for Redis read operations (replicas with master fallback)
frontend redis_read_frontend
    bind *:6380
    default_backend redis_replicas

# Backend for Redis master (write operations)
backend redis_master
    option tcp-check
    tcp-check send PING\r\n
    tcp-check expect string +PONG
    server redis-master redis-master:6379 check

# Backend for Redis replicas (read operations)
backend redis_replicas
    balance roundrobin
    option tcp-check
    tcp-check send PING\r\n
    tcp-check expect string +PONG
    
    # Replicas (preferred for reads)
    server redis-replica-1 redis-replica-1:6379 check weight 100
    server redis-replica-2 redis-replica-2:6379 check weight 100
    
    # Master as backup for reads
    server redis-master redis-master:6379 check weight 50 backup

# HAProxy Statistics
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE